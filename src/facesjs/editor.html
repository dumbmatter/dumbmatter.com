<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>faces.js editor</title>
    <link
      rel="stylesheet"
      href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css"
      integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm"
      crossorigin="anonymous"
    />
    <style>
      .mb-lots {
        margin-bottom: 3rem;
      }

      #face {
        height: 600px;
        width: 400px;
      }
    </style>
  </head>
  <body>
    <div class="container-fluid">
      <div class="row">
        <div class="col">
          <h1 class="mb-4 mt-2">
            faces.js editor
            <button
              type="button"
              class="btn btn-primary btn-lg ml-3"
              id="randomize"
            >
              Randomize
            </button>
          </h1>
          <div class="row">
            <div class="col">
              <form>
                <div class="row">
                  <div class="col">
                    <h4>Head</h4>
                    <div class="form-group">
                      <select class="form-control" id="head-id"> </select>
                    </div>
                    <div class="form-group">
                      <label for="head-shave">Shave</label>
                      <input type="text" class="form-control" id="head-shave" />
                    </div>
                    <div class="form-group mb-lots">
                      <label for="fatness">Fatness</label>
                      <input
                        type="number"
                        class="form-control"
                        id="fatness"
                        min="0"
                        max="1"
                        step="0.01"
                      />
                    </div>

                    <h4>Hair</h4>
                    <div class="form-group">
                      <select class="form-control" id="hair-id"> </select>
                    </div>
                    <div class="form-group mb-lots">
                      <label for="hair-color">Hair color</label>
                      <input
                        type="color"
                        class="form-control"
                        id="hair-color"
                      />
                    </div>

                    <h4>Eye Lines</h4>
                    <div class="form-group mb-lots">
                      <select class="form-control" id="eyeLine-id"> </select>
                    </div>
                  </div>
                  <div class="col">
                    <h4>Eyebrows</h4>
                    <div class="form-group">
                      <select class="form-control" id="eyebrow-id"> </select>
                    </div>
                    <div class="form-group mb-lots">
                      <label for="eyebrow-angle">Angle</label>
                      <input
                        type="number"
                        class="form-control"
                        id="eyebrow-angle"
                        min="-15"
                        max="20"
                        step="1"
                      />
                    </div>

                    <h4>Eyes</h4>
                    <div class="form-group">
                      <select class="form-control" id="eye-id"> </select>
                    </div>
                    <div class="form-group mb-lots">
                      <label for="eye-angle">Angle</label>
                      <input
                        type="number"
                        class="form-control"
                        id="eye-angle"
                        min="-15"
                        max="20"
                        step="1"
                      />
                    </div>

                    <h4>Smile Lines</h4>
                    <div class="form-group">
                      <select class="form-control" id="smileLine-id"> </select>
                    </div>
                    <div class="form-group mb-lots">
                      <label for="smileLine-size">Size</label>
                      <input
                        type="number"
                        class="form-control"
                        id="smileLine-size"
                        min=".5"
                        max="1.5"
                        step="0.01"
                      />
                    </div>
                  </div>
                  <div class="col">
                    <h4>Misc Lines</h4>
                    <div class="form-group mb-lots">
                      <select class="form-control" id="miscLine-id"> </select>
                    </div>

                    <h4>Facial Hair</h4>
                    <div class="form-group mb-lots">
                      <select class="form-control" id="facialHair-id"> </select>
                    </div>

                    <h4>Nose</h4>
                    <div class="form-group">
                      <select class="form-control" id="nose-id"> </select>
                    </div>
                    <div class="form-group">
                      <label for="nose-size">Size</label>
                      <input
                        type="number"
                        class="form-control"
                        id="nose-size"
                        min=".5"
                        max="1.25"
                        step="0.01"
                      />
                    </div>
                    <div class="form-group form-check mb-lots">
                      <input
                        class="form-check-input"
                        type="checkbox"
                        value=""
                        id="nose-flip"
                      />
                      <label class="form-check-label" for="nose-flip">
                        Flip
                      </label>
                    </div>

                    <h4>Mouth</h4>
                    <div class="form-group">
                      <select class="form-control" id="mouth-id"> </select>
                    </div>
                    <div class="form-group form-check mb-lots">
                      <input
                        class="form-check-input"
                        type="checkbox"
                        value=""
                        id="mouth-flip"
                      />
                      <label class="form-check-label" for="mouth-flip">
                        Flip
                      </label>
                    </div>
                  </div>
                  <div class="col">
                    <h4>Body</h4>
                    <div class="form-group">
                      <select class="form-control" id="body-id"> </select>
                    </div>
                    <div class="form-group mb-lots">
                      <label for="body-color">Skin color</label>
                      <input
                        type="color"
                        class="form-control"
                        id="body-color"
                      />
                    </div>

                    <h4>Ear</h4>
                    <div class="form-group">
                      <select class="form-control" id="ear-id"> </select>
                    </div>
                    <div class="form-group mb-lots">
                      <label for="ear-size">Size</label>
                      <input
                        type="number"
                        class="form-control"
                        id="ear-size"
                        min=".5"
                        max="1.25"
                        step="0.01"
                      />
                    </div>

                    <h4>Accessories</h4>
                    <div class="form-group mb-lots">
                      <select class="form-control" id="accessories-id">
                      </select>
                    </div>
                  </div>
                  <div class="col">
                    <h4>Glasses</h4>
                    <div class="form-group mb-lots">
                      <select class="form-control" id="glasses-id"> </select>
                    </div>

                    <h4>Jersey</h4>
                    <div class="form-group mb-lots">
                      <select class="form-control" id="jersey-id"> </select>
                    </div>

                    <h4>Team Colors</h4>
                    <div class="form-group">
                      <label for="teamColors-0">Primary</label>
                      <input
                        type="color"
                        class="form-control"
                        id="teamColors-0"
                      />
                    </div>
                    <div class="form-group">
                      <label for="teamColors-1">Secondary</label>
                      <input
                        type="color"
                        class="form-control"
                        id="teamColors-1"
                      />
                    </div>
                    <div class="form-group mb-lots">
                      <label for="teamColors-2">Accent</label>
                      <input
                        type="color"
                        class="form-control"
                        id="teamColors-2"
                      />
                    </div>
                  </div>
                </div>
              </form>
            </div>
          </div>
        </div>
        <div class="col" style="flex: 0 0 400px;">
          <div id="face"></div>
          <textarea id="json" class="form-control mt-3"></textarea>
          <button class="btn btn-secondary mt-1" id="copy">
            Copy to clipboard
          </button>
        </div>
      </div>
    </div>
  </body>
  <script src="build/bundle.js"></script>
  <script>
    const faceWrapper = document.getElementById("face");
    const jsonElement = document.getElementById("json");

    document.getElementById("copy").addEventListener("click", () => {
      jsonElement.focus();
      jsonElement.select();

      const successful = document.execCommand("copy");
      const msg = successful ? "successful" : "unsuccessful";
      console.log("Copying text command was " + msg);
    });

    let face;
    if (location.hash.length <= 1) {
      face = faces.generate();
    } else {
      try {
        face = JSON.parse(atob(location.hash.slice(1)));
      } catch (error) {
        console.error(error);
        face = faces.generate();
      }
    }

    const updateDisplay = () => {
      console.log(face);
      faces.display(faceWrapper, face);
      history.replaceState(
        undefined,
        undefined,
        `#${btoa(JSON.stringify(face))}`
      );
      jsonElement.value = JSON.stringify(face);
    };

    const initializeSelectOptions = () => {
      for (const feature of Object.keys(faces.svgsIndex)) {
        const options = faces.svgsIndex[feature];
        const selectElement = document.getElementById(`${feature}-id`);
        for (const option of options) {
          const optionElement = document.createElement("option");
          optionElement.value = option;
          optionElement.text = option;
          selectElement.add(optionElement, null);
        }
      }
    };

    const isValue = obj =>
      typeof obj === "boolean" ||
      typeof obj === "number" ||
      typeof obj === "string";

    const initializeFormValue = (id, value) => {
      const element = document.getElementById(id);
      if (element.classList.contains("form-check-input")) {
        element.checked = value;
      } else {
        element.value = value;
      }
    };

    const initializeFormValues = () => {
      for (const key of Object.keys(face)) {
        if (isValue(face[key])) {
          initializeFormValue(key, face[key]);
        } else {
          for (const key2 of Object.keys(face[key])) {
            if (isValue(face[key][key2])) {
              initializeFormValue(`${key}-${key2}`, face[key][key2]);
            } else {
              throw new Error(`wtf is in face.${key}.${key2}`);
            }
          }
        }
      }
    };

    const getValue = (oldValue, event) => {
      if (typeof oldValue === "number") {
        return parseFloat(event.target.value);
      }
      if (typeof oldValue === "boolean") {
        return event.target.checked;
      }
      return event.target.value;
    };
    const listenForChanges = () => {
      const textInputs = document.querySelectorAll("input.form-control");
      const checkboxInputs = document.querySelectorAll(
        "input.form-check-input"
      );
      const selects = document.querySelectorAll("select.form-control");

      for (const input of [...textInputs, ...checkboxInputs, ...selects]) {
        input.addEventListener("change", event => {
          const parts = event.target.id.split("-");

          if (parts.length === 1) {
            face[parts[0]] = getValue(face[parts[0]], event);
          } else if (parts.length === 2) {
            face[parts[0]][parts[1]] = getValue(
              face[parts[0]][parts[1]],
              event
            );
          } else {
            throw new Error(`Invalid ID ${event.target.id}`);
          }

          updateDisplay();
        });
      }

      document.getElementById("randomize").addEventListener("click", () => {
        face = faces.generate();
        initializeFormValues();
        updateDisplay();
      });
    };

    updateDisplay();
    initializeSelectOptions();
    initializeFormValues();
    listenForChanges();
  </script>

  <script type="text/javascript">
    if (location.host.indexOf("dumbmatter.com") >= 0) {
      (function(i, s, o, g, r, a, m) {
        i["GoogleAnalyticsObject"] = r;
        (i[r] =
          i[r] ||
          function() {
            (i[r].q = i[r].q || []).push(arguments);
          }),
          (i[r].l = 1 * new Date());
        (a = s.createElement(o)), (m = s.getElementsByTagName(o)[0]);
        a.async = 1;
        a.src = g;
        m.parentNode.insertBefore(a, m);
      })(
        window,
        document,
        "script",
        "https://www.google-analytics.com/analytics.js",
        "ga"
      );
      ga("create", "UA-23918822-2", "auto");
      ga("send", "pageview");
    }
  </script>
</html>
